<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Plaid + Python MVP</title>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  </head>
  <body>
    <h1>Node + Plaid + Python Demo</h1>
    <button id="linkButton">Connect to Bank</button>
    <button id="transactionsButton">Get Transactions</button>
    <pre id="output"></pre>

    <script>
      const linkButton = document.getElementById("linkButton");
      const transactionsButton = document.getElementById("transactionsButton");
      const output = document.getElementById("output");

      // 1) Request a Link token, then open Plaid Link
      linkButton.addEventListener("click", async () => {
        try {
          const resp = await fetch("/api/create_link_token", { method: "POST" });
          const data = await resp.json();
          if (!data.link_token) {
            output.textContent = "Failed to create link token.";
            return;
          }

          const handler = Plaid.create({
            token: data.link_token,
            onSuccess: async (public_token, metadata) => {
              // 2) Exchange public token for access token
              const exchangeRes = await fetch("/api/exchange_public_token", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ public_token }),
              });
              if (exchangeRes.ok) {
                output.textContent = "Access token obtained!";
              } else {
                output.textContent = "Error exchanging public token.";
              }
            },
            onExit: (err, metadata) => {
              if (err != null) {
                output.textContent = "User exited Plaid Link flow.";
              }
            },
          });
          handler.open();
        } catch (error) {
          console.error(error);
          output.textContent = "Error creating link token.";
        }
      });

      // 3) Retrieve transactions and see the Python-processed summary
      transactionsButton.addEventListener("click", async () => {
        try {
          const txRes = await fetch("/api/transactions");
          if (!txRes.ok) {
            output.textContent = await txRes.text();
            return;
          }
          const processedData = await txRes.json();
          output.textContent = JSON.stringify(processedData, null, 2);
        } catch (error) {
          console.error(error);
          output.textContent = "Error fetching transactions.";
        }
      });
    </script>
  </body>
</html>
